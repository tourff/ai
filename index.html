// mini-chatgpt.js
import express from "express";
import cors from "cors";
import OpenAI from "openai";
import path from "path";
import { fileURLToPath } from "url";
import fs from "fs";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(cors());
app.use(express.json());

// OpenAI setup
const openai = new OpenAI({ apiKey: "YOUR_OPENAI_API_KEY" }); // Replace with your API key

// Serve frontend HTML directly
app.get("/", (req, res) => {
  res.send(`
  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini ChatGPT</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md bg-white p-5 rounded-xl shadow-lg">
      <h1 class="text-xl font-bold text-center mb-4">Chat with AI</h1>

      <div id="chat" class="h-80 overflow-y-auto border rounded p-2 bg-gray-50 mb-4"></div>

      <input id="userInput" type="text" placeholder="Type your message..." 
             class="w-full p-2 border rounded focus:outline-none">
      <button onclick="sendMessage()" 
              class="mt-2 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Send</button>
    </div>

    <script>
      async function sendMessage() {
        const input = document.getElementById('userInput');
        const chat = document.getElementById('chat');
        const msg = input.value.trim();
        if(!msg) return;

        // Show user message
        chat.innerHTML += \`<div class="text-right mb-2"><span class="bg-blue-200 px-3 py-1 rounded">\${msg}</span></div>\`;
        input.value = '';

        // Show placeholder for AI
        chat.innerHTML += \`<div class="text-left mb-2" id="typing"><span class="bg-gray-200 px-3 py-1 rounded">Typing...</span></div>\`;
        chat.scrollTop = chat.scrollHeight;

        // Fetch AI response from backend
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({message: msg})
        });

        const data = await res.json();
        document.getElementById('typing').innerHTML = \`<span class="bg-gray-200 px-3 py-1 rounded">\${data.response}</span>\`;
        chat.scrollTop = chat.scrollHeight;
      }
    </script>

  </body>
  </html>
  `);
});

// Backend route to get AI response
app.post("/api/chat", async (req, res) => {
  const userMessage = req.body.message;

  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-5-mini",
      messages: [{ role: "user", content: userMessage }],
    });

    const aiResponse = completion.choices[0].message.content;
    res.json({ response: aiResponse });
  } catch (err) {
    console.error(err);
    res.status(500).json({ response: "Something went wrong!" });
  }
});

// Start server
app.listen(3000, () => console.log("Mini ChatGPT running on http://localhost:3000"));
